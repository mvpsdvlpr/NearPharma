<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>BuscaFarmacia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
  <style>
    body { font-family: Roboto, Arial, sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
    .container { max-width: 600px; margin: 2rem auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 2rem; }
    h1 { text-align: center; color: #2c3e50; }
    label { font-weight: bold; }
    select, button { width: 100%; margin: 0.5rem 0; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; }
    .filtros { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .filtro-btn { flex: 1 1 45%; min-width: 120px; cursor: pointer; background: #f1f1f1; border: none; border-radius: 4px; padding: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .filtro-btn.selected { background: #2c3e50; color: #fff; }
    .farmacia-list { margin-top: 2rem; }
    .farmacia-card { background: #f1f1f1; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
    .farmacia-card h3 { margin: 0 0 0.5rem 0; }
    .tipo-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #28a745;
      color: #fff;
      border-radius: 20px;
      padding: 4px 16px 4px 8px;
      font-size: 1em;
      font-weight: 500;
      margin-top: 8px;
    }
    .tipo-pill img {
      background: #fff;
      border-radius: 50%;
      padding: 2px;
      width: 22px;
      height: 22px;
    }
    .farmacia-logo { border-radius: 6px; background: #fff; padding: 2px; }
    #mapid { height: 400px; margin-top: 2rem; border-radius: 8px; }
    @media (max-width: 600px) {
      .container { padding: 1rem; }
      .filtros { flex-direction: column; }
      #mapid { height: 250px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>BuscaFarmacia</h1>
    <div class="filtros" id="filtros"></div>
    <label for="fecha" id="fecha-label" style="display:none;">Fecha de turno</label>
    <select id="fecha" style="display:none;">
      <option value="">Cargando...</option>
    </select>
    <label for="region">Región</label>
    <select id="region">
      <option value="">Cargando...</option>
    </select>
    <label for="comuna">Comuna</label>
    <select id="comuna" disabled>
      <option value="">Seleccione región primero</option>
    </select>
    <button id="geo-btn">Usar mi ubicación</button>
    <div class="farmacia-list" id="farmacia-list"></div>
    <div id="mapid"></div>
  </div>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
  <script>
    // Usa un proxy CORS para desarrollo local
    const ENDPOINT = 'https://corsproxy.io/?https://seremienlinea.minsal.cl/asdigital/mfarmacias/mapa.php';

    let filtro = 'turnos';
    let fecha = '';

    // Diccionarios para nombres y tipos
    let comunasNombres = {};
    let regionesNombres = {};
    let iconosTipos = [];
    let titulosTipos = [];

    // Mapa y marcadores
    let map = null;
    let farmaciaMarkers = [];

    // 1. Cargar tipos de farmacia y crear botones de filtro
    fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ func: 'iconos' })
    })
    .then(res => res.json())
    .then(data => {
      if (data.correcto) {
        data.iconos.forEach((icono, idx) => {
          iconosTipos[idx] = icono;
          titulosTipos[idx] = data.titulos[idx];
        });
        const filtrosDiv = document.getElementById('filtros');
        filtrosDiv.innerHTML = '';
        data.iconos.forEach((icono, idx) => {
          const btn = document.createElement('button');
          btn.className = 'filtro-btn' + (icono === 'turnos' ? ' selected' : '');
          btn.innerHTML = `<span>${data.titulos[idx]}</span>`;
          btn.onclick = () => seleccionarFiltro(icono, btn);
          filtrosDiv.appendChild(btn);
        });
        seleccionarFiltro('turnos', filtrosDiv.querySelector('.filtro-btn.selected'));
      }
    });

    function seleccionarFiltro(nuevoFiltro, btn) {
      filtro = nuevoFiltro;
      document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('selected'));
      if (btn) btn.classList.add('selected');
      if (filtro === 'turnos') {
        document.getElementById('fecha').style.display = '';
        document.getElementById('fecha-label').style.display = '';
        cargarFechas();
      } else {
        document.getElementById('fecha').style.display = 'none';
        document.getElementById('fecha-label').style.display = 'none';
        fecha = '';
        buscarFarmacias();
      }
    }

    function cargarFechas() {
      fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ func: 'fechas' })
      })
      .then(res => res.json())
      .then(data => {
        const fechaSel = document.getElementById('fecha');
        fechaSel.innerHTML = '<option value="">Seleccione fecha</option>';
        if (data.correcto) {
          Object.entries(data.respuesta).forEach(([key, val]) => {
            fechaSel.innerHTML += `<option value="${key}">${val}</option>`;
          });
        }
        fechaSel.style.display = '';
        document.getElementById('fecha-label').style.display = '';
      });
    }

    document.getElementById('fecha').addEventListener('change', function() {
      fecha = this.value;
      buscarFarmacias();
    });

    fetch(ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ func: 'regiones' })
    })
    .then(res => res.json())
    .then(data => {
      const regionSel = document.getElementById('region');
      regionSel.innerHTML = '<option value="">Seleccione región</option>';
      if (data.correcto) {
        data.respuesta.forEach(r => {
          regionSel.innerHTML += `<option value="${r.id}" data-lat="${r.lat}" data-lng="${r.lng}">${r.nombre}</option>`;
          regionesNombres[r.id] = r.nombre;
        });
      }
    });

    document.getElementById('region').addEventListener('change', function() {
      const regionId = this.value;
      const comunaSel = document.getElementById('comuna');
      comunaSel.disabled = true;
      comunaSel.innerHTML = '<option value="">Cargando...</option>';
      if (!regionId) {
        comunaSel.innerHTML = '<option value="">Seleccione región primero</option>';
        return;
      }
      fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ func: 'comunas', region: regionId })
      })
      .then(res => res.json())
      .then(data => {
        comunaSel.innerHTML = '<option value="">Seleccione comuna</option>';
        if (data.correcto) {
          data.respuesta.forEach(c => {
            comunaSel.innerHTML += `<option value="${c.id}" data-lat="${c.lat}" data-lng="${c.lng}">${c.nombre}</option>`;
            comunasNombres[c.id] = c.nombre;
          });
          comunaSel.disabled = false;
        }
      });
    });

    document.getElementById('comuna').addEventListener('change', buscarFarmacias);

    document.getElementById('geo-btn').addEventListener('click', function() {
      if (!navigator.geolocation) {
        alert('Geolocalización no soportada');
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        buscarFarmaciasPorUbicacion(pos.coords.latitude, pos.coords.longitude);
      }, () => alert('No se pudo obtener ubicación'));
    });

    function initMap(lat = -33.45, lng = -70.65, zoom = 12) {
      if (map) {
        map.setView([lat, lng], zoom);
        return;
      }
      map = L.map('mapid').setView([lat, lng], zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
    }

    function clearMarkers() {
      if (farmaciaMarkers && farmaciaMarkers.length) {
        farmaciaMarkers.forEach(m => map.removeLayer(m));
      }
      farmaciaMarkers = [];
    }

    function buscarFarmacias() {
      const regionId = document.getElementById('region').value;
      const comunaId = document.getElementById('comuna').value;
      if (!regionId || !comunaId || (filtro === 'turnos' && !fecha)) return;
      fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          func: 'region',
          filtro: filtro,
          fecha: filtro === 'turnos' ? fecha : '',
          region: regionId,
          hora: new Date().toLocaleTimeString('es-CL', { hour12: false })
        })
      })
      .then(res => res.json())
      .then(data => {
        mostrarFarmacias(data.respuesta.locales || []);
      });
    }

    function buscarFarmaciasPorUbicacion(lat, lng) {
      document.getElementById('farmacia-list').innerHTML = '<div>Funcionalidad de búsqueda por ubicación en desarrollo.</div>';
    }

    function mostrarFarmacias(locales) {
      const list = document.getElementById('farmacia-list');
      if (!locales.length) {
        list.innerHTML = '<div>No se encontraron farmacias.</div>';
        clearMarkers();
        return;
      }
      list.innerHTML = '';
      clearMarkers();

      // Inicializa el mapa en la primera farmacia válida
      let centerLat = -33.45, centerLng = -70.65;
      for (let i = 0; i < locales.length; i++) {
        if (locales[i].lat && locales[i].lng) {
          centerLat = parseFloat(locales[i].lat);
          centerLng = parseFloat(locales[i].lng);
          break;
        }
      }
      initMap(centerLat, centerLng, 13);

      // Agrega todos los marcadores al mapa
      locales.forEach(local => {
        const tipoFarmacia = local.tp;
        // Mostrar tarjeta
        fetch(ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            func: 'local',
            im: local.im,
            fecha: fecha
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.correcto && data.respuesta && data.respuesta.local) {
            const f = data.respuesta.local;
            const horario = data.respuesta.horario || {};
            const tipoIdx = Number(tipoFarmacia);
            const tipo = iconosTipos[tipoIdx] || '';
            const tipoNombre = titulosTipos[tipoIdx] || '';
            const comuna = comunasNombres[f.cm] || '';
            const region = regionesNombres[f.rg] || '';
            const logo = f.img
              ? `https://seremienlinea.minsal.cl/asdigital/mfarmacias/mapa.php?imagen=${f.img}`
              : 'https://seremienlinea.minsal.cl/asdigital/mfarmacias/img/logo.svg';
            const card = document.createElement('div');
            card.className = 'farmacia-card';
            card.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <h3>${f.nm || ''}</h3>
                  ${horario.turno ? `<hr><label><b>Fecha Turno</b></label><br>${horario.turno}<hr>` : ''}
                </div>
                <div><img src="${logo}" class="farmacia-logo" width="50"></div>
              </div>
              <div>
                <label><b>Horario Semanal</b></label><br>${horario.semana || 'No disponible'}<br>
                <label><b>Dirección</b></label><br>
                ${f.dr || ''},<br>${comuna}, ${region}.<br>
                <img src="https://seremienlinea.minsal.cl/asdigital/mfarmacias/img/map.svg" width="15">&nbsp;
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((f.dr || '') + ', ' + comuna + ', ' + region)}" target="_blank">¿Cómo llegar?</a><br>
                ${f.tl ? `<label><b>Teléfono</b></label><br><a href="tel:${f.tl}">${f.tl}</a>` : ''}
              </div>
              <div style="margin-top:12px;display:flex;justify-content:flex-end;">
                <span class="tipo-pill">
                  <img src="https://seremienlinea.minsal.cl/asdigital/mfarmacias/img/i${tipo}b.png" alt="" />
                  ${tipoNombre}
                </span>
              </div>
            `;
            list.appendChild(card);

            // Agregar marcador al mapa si hay lat/lng
            // El objeto local (del listado) debe tener lat/lng
            if (local.lat && local.lng) {
              const lat = parseFloat(local.lat);
              const lng = parseFloat(local.lng);
              const marker = L.marker([lat, lng]).addTo(map)
                .bindPopup(`
                  <b>${f.nm || ''}</b><br>
                  ${f.dr || ''}, ${comuna}, ${region}.<br>
                  <span class="tipo-pill" style="display:inline-flex;align-items:center;gap:6px;background:#28a745;color:#fff;border-radius:20px;padding:4px 16px 4px 8px;font-size:1em;font-weight:500;margin-top:8px;">
                    <img src="https://seremienlinea.minsal.cl/asdigital/mfarmacias/img/i${tipo}b.png" style="background:#fff;border-radius:50%;padding:2px;width:22px;height:22px;">
                    ${tipoNombre}
                  </span>
                `);
              farmaciaMarkers.push(marker);
            }
          } else {
            const card = document.createElement('div');
            card.className = 'farmacia-card';
            card.innerHTML = '<div>No se pudo cargar la información.</div>';
            list.appendChild(card);
          }
        })
        .catch(() => {
          const card = document.createElement('div');
          card.className = 'farmacia-card';
          card.innerHTML = '<div>No se pudo cargar la información.</div>';
          list.appendChild(card);
        });
      });
    }
  </script>
</body>
</html>